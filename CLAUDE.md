# CLAUDE.md - Istruzioni Complete per Claude Code
## Progetto: Vitaeology - Leadership Development Platform

**Versione:** 2.9
**Ultimo aggiornamento:** 26 Gennaio 2026
**Owner:** Fernando Marongiu

---

## CONTESTO PROGETTO

Vitaeology Ã¨ una **piattaforma SaaS completa** per lo sviluppo della leadership destinata a imprenditori italiani (35-55 anni).

### Stack Tecnologico
| Tecnologia | Versione | Uso |
|------------|----------|-----|
| Next.js | 14.x | App Router, SSR |
| TypeScript | 5.x | Tipizzazione strict |
| Supabase | - | PostgreSQL + Auth + RLS |
| Tailwind CSS | 3.x | Styling |
| Stripe | - | Pagamenti subscription + one-time |
| Anthropic Claude | - | AI Coach |
| OpenAI | - | Embeddings RAG |
| Resend | - | Email automation |
| Vercel | - | Hosting + Cron |

### Integrazioni Attive
- **ANTHROPIC_API_KEY** â†’ AI Coach Fernando
- **OPENAI_API_KEY** â†’ Embeddings per RAG (3 libri)
- **STRIPE_SECRET_KEY** â†’ Pagamenti
- **RESEND_API_KEY** â†’ Email challenge
- **SUPABASE** â†’ Database + Auth

---

## DATI BIOGRAFICI FERNANDO MARONGIU (OBBLIGATORIO)

**âš ï¸ SEMPRE verificare le etÃ  quando si scrive contenuto su Fernando!**

### Riferimento Rapido
| Dato | Valore |
|------|--------|
| **Anno di nascita** | 1957 |
| **EtÃ  attuale (2026)** | 68-69 anni |

### Calcolo EtÃ  per Anno
```
EtÃ  = Anno evento - 1957
```

### Eventi Chiave nelle Storie
| Anno | EtÃ  Fernando | Evento/Storia |
|------|--------------|---------------|
| 1973 | **16 anni** | Inizio "anni perduti" (MicrofelicitÃ ) |
| 1982 | **25 anni** | Fine "anni perduti" |
| 1989 | **32 anni** | Cabina telefonica #1: chiedere permesso a manager (Leadership) |
| 1992 | **35 anni** | Covey "7 Habits" pubblicato in italiano |
| 1993 | **36 anni** | Cabina telefonica #2: tessera ristoranti "TheFork" (Ostacoli) |
| Primi 2000 | ~45 anni | Fallimento energie rinnovabili |
| 2007 | **50 anni** | Ingresso settore oro/gioielleria |
| 2024 | **67 anni** | Fondazione Vitaeology |
| 2026 | **68-69 anni** | Oggi |

### Due Episodi Cabina Telefonica (NON confondere!)
1. **1989 (Leadership)**: Parlava con un manager, chiedeva "il permesso" di essere riconosciuto come persona lungimirante. Sensazione di essere relegato a comprimario.
2. **1993 (Ostacoli)**: Progetto tessera ristoranti (precursore TheFork). Settimane a chiamare ristoranti da cabina telefonica.

### Regola
```
âŒ MAI inventare etÃ  senza calcolare: Anno - 1957
âœ… SEMPRE verificare: "Nel [ANNO] avevo [ANNO - 1957] anni"
```

---

## PRINCIPI FONDAMENTALI (OBBLIGATORI)

### 0. Framework dei 4 Prodotti (Fondamento)

Ogni sistema di produzione genera **4 prodotti fondamentali**, ciascuno governato da **3 fattori**:

#### I 4 Prodotti

| # | Prodotto | Definizione | In Vitaeology |
|---|----------|-------------|---------------|
| **P1** | L'istituzione di ciÃ² che produce | Il sistema/macchina che genera | Piattaforma (Challenge, Assessment, Esercizi) |
| **P2** | Il prodotto generato | L'output creato | Trasformazione utente (risultati, completamenti, consapevolezza) |
| **P3** | La riparazione di ciÃ² che produce | Manutenzione del sistema | Bug fix, UX improvements, ottimizzazioni |
| **P4** | La correzione del prodotto generato | Correzione dell'output | **AI Coach Fernando** (supporto on-demand) |

#### I 3 Fattori (per ogni prodotto)

| Fattore | Significato | Domanda Guida |
|---------|-------------|---------------|
| **QuantitÃ ** | Ammontare | "Quanto ne produciamo?" |
| **QualitÃ ** | Grado di perfezione | "Quanto Ã¨ ben fatto?" |
| **Viability** | LongevitÃ , utilitÃ , desiderabilitÃ  | "Quanto dura e serve?" |

**Totale: 4 Prodotti Ã— 3 Fattori = 12 Fattori di Produzione**

#### Regola Critica
```
NON confondere i 4 prodotti tra loro.
Ogni prodotto ha il suo contesto e momento.
```

#### Applicazione a Vitaeology

```
P1 (Sistema)     â†’ Costruisce i funnel e le funzionalitÃ 
P2 (Output)      â†’ Consegnato all'utente ai punti STOP
P3 (Manutenzione)â†’ Migliora il sistema nel tempo
P4 (Correzione)  â†’ Disponibile ON-DEMAND, non imposto
```

**Errore tipico:** Trattare P4 (AI Coach) come P2 (output da consumare), proponendolo ai punti STOP dove l'utente deve ricevere il suo output, non una correzione.

**Soluzione:** AI Coach (P4) vive sulla Dashboard, disponibile quando l'utente SCEGLIE di correggere/migliorare il suo percorso.

---

### 1. Principio Validante: AVERE vs ESSERE/FARE (ESSENZIALE)

**ESSERE, FARE, AVERE sono condizioni di esistenza.**

#### La Differenza Fondamentale: LIBERTÃ€

| Condizione | Il soggetto... | Risultato |
|------------|----------------|-----------|
| **ESSERE/FARE** | Ãˆ alla mercÃ© del giudizio | Invalidazione o valutazione |
| **AVERE/NON AVERE** | Ha una scelta | **LIBERTÃ€** |

**AVERE e NON AVERE sono due possibilitÃ  che implicano un livello di libertÃ .**
Se posso AVERE o anche NON AVERE una cosa o una scelta â€” questa Ã¨ una condizione di LIBERTÃ€.

#### PerchÃ© ESSERE e FARE sono problematici
ESSERE e FARE mettono il soggetto **alla completa "mercÃ©"** di chi parla â€” sono per lo piÃ¹ **invalidanti** (giudicano negativamente) o **valutanti** (giudicano, anche se positivamente). Il soggetto non ha scelta: Ãˆ o NON Ãˆ, FA o NON FA.

#### PerchÃ© AVERE implica libertÃ 
AVERE/NON AVERE riconoscono che il soggetto **puÃ² scegliere**. "Hai questa capacitÃ " significa anche "puoi scegliere di usarla o no". La libertÃ  sta nella possibilitÃ  stessa.

#### Applicazione Pratica
```
âœ… Enfatizzare AVERE: "Hai giÃ ...", "Possiedi...", "Puoi scegliere di..."
   â†’ Riconosce possesso E libertÃ  di scelta

âŒ Evitare deficit forzati: "Ti manca...", "Non hai..." (come sentenza)
   â†’ Rimuove la libertÃ , impone un giudizio

âŒ Evitare ESSERE: "Sei/Non sei..."
   â†’ Giudizio identitario, nessuna via d'uscita

âŒ Evitare FARE: "Fai/Non fai..."
   â†’ Giudizio comportamentale, alla mercÃ© del giudicante
```

#### Esempi Pratici
| âŒ Sbagliato (giudizio/deficit) | âœ… Corretto (riconoscimento/libertÃ ) |
|--------------------------------|--------------------------------------|
| "Non sei un vero leader" | "Hai capacitÃ  di leadership â€” puoi scegliere come usarle" |
| "Ti manca la visione" | "Hai una visione â€” puoi ampliarla se vuoi" |
| "Devi migliorare" | "Hai risorse che puoi attivare" |
| "Sei bravo" | "Questo Ã¨ qualcosa che hai" |
| "Non fai abbastanza" | "Hai piÃ¹ opzioni di quelle che stai usando" |

**L'utente POSSIEDE GIÃ€ tutte le capacitÃ  di leadership. Ha la LIBERTÃ€ di riconoscerle e usarle.**

---

### 2. User Agency
- L'utente Ã¨ **AGENTE attivo**, non paziente passivo
- Mai prescrizioni dirette ("devi fare X")
- Sempre domande e facilitazione

### 3. AI Coach = FERNANDO (mai Marco)
```
âœ… "Sono Fernando, il tuo AI Coach"
âŒ "Sono Marco" (ERRORE CRITICO)
```

### 4. Principio STOP â†’ START (Customer Journey)

Il Customer Journey segue cicli **START â†’ CHANGE â†’ STOP**:
- **START**: L'utente inizia un'azione (es. inizia assessment)
- **CHANGE**: L'utente Ã¨ nel processo (es. risponde alle domande)
- **STOP**: L'utente completa l'azione (es. vede i risultati)

#### Regola Fondamentale
```
Ogni STOP deve avere UNA CTA chiara che motiva al SÃŒ verso il prossimo START.
NO opzioni multiple che creano incertezza decisionale.
```

#### AI Coach Fernando: Dove SÃŒ e Dove NO

| Contesto | AI Coach | Motivo |
|----------|----------|--------|
| **Dashboard** | âœ… SÃŒ | Hub neutro, l'utente sceglie |
| **Assessment Results** | âŒ NO | CTA chiara: "Inizia Esercizio" |
| **Challenge Day 1-7** | âŒ NO | Focus sul contenuto strutturato |
| **Challenge Complete** | âŒ NO | CTA chiara: "Fai Assessment" |
| **Subscription Success** | âŒ NO | CTA chiara: "Vai alla Dashboard" |
| **Exercise Complete** | âŒ NO | CTA chiara: "Prossimo Esercizio" |
| **Email transazionali** | âŒ NO | CTA diretta all'azione |

#### PerchÃ© NO ai punti STOP?
1. **AI Coach Ã¨ conversazione aperta** â†’ Gli STOP richiedono direzione precisa
2. **Crea attrito decisionale** â†’ "Clicco esercizi O parlo con Fernando?"
3. **Lo STOP deve motivare UN solo SÃŒ** â†’ Non dare alternative ambigue

#### Esempio Corretto
```
STOP: Assessment Results
  âŒ "Parla con Fernando dei tuoi risultati" (ambiguo)
  âœ… "Inizia l'Esercizio per la tua Area di Crescita" (azione chiara)
```

---

### 5. Framework Verifica Comprensione (FORMAZIONE)

> **Principio:** Se l'esame finale verifica comprensione a 3 livelli, TUTTO il percorso formativo deve preparare a quei livelli fin dall'inizio.

#### Le 3 Barriere alla Comprensione (da prevenire SEMPRE)

| Barriera | Significato | Come Prevenire |
|----------|-------------|----------------|
| **Parola mal compresa** | L'utente non capisce un termine | Spiegare OGNI termine non comune immediatamente |
| **Mancanza di concretezza** | Concetti astratti senza esempi | SEMPRE esempi dalla vita reale dell'imprenditore |
| **Gradiente saltato** | Passaggi logici mancanti | Progressione graduale, mai saltare step |

#### I 3 Livelli di Comprensione (da costruire in OGNI contenuto)

| Livello | Cosa Insegna | Domanda di Verifica | Applicazione |
|---------|--------------|---------------------|--------------|
| **DATI STABILI** | Il "COSA" - definizioni, regole, principi | "Cos'Ã¨ [X]? Definiscilo con parole tue" | Ogni esercizio deve definire i concetti chiave |
| **DOINGNESS** | Il "COME" - passi concreti, procedura | "Come si fa [X]? Descrivi i passi" | Ogni esercizio deve avere istruzioni step-by-step |
| **TEORIA** | Il "PERCHÃ‰" - logica sottostante, scopo | "PerchÃ© funziona [X]?" | Ogni esercizio deve spiegare il razionale |

#### Applicazione Pratica

```
âš ï¸ REGOLA: Ogni contenuto formativo (esercizio, challenge, assessment) deve:

1. PREVENIRE le 3 barriere:
   - Glossario/spiegazione termini integrata
   - Esempi concreti per ogni concetto
   - Progressione graduale verificabile

2. COSTRUIRE i 3 livelli:
   - Definire COSA si sta imparando (Dati Stabili)
   - Mostrare COME si applica (Doingness)
   - Spiegare PERCHÃ‰ funziona (Teoria)

3. VERIFICARE la comprensione:
   - Domande di riflessione che testano i 3 livelli
   - Deliverable che dimostrano applicazione pratica
```

#### Checklist per Ogni Contenuto Formativo

- [ ] **Termini:** Tutti i termini non comuni sono spiegati?
- [ ] **Esempi:** Ci sono esempi concreti dalla vita imprenditoriale?
- [ ] **GradualitÃ :** La progressione Ã¨ logica e senza salti?
- [ ] **Dati Stabili:** L'utente saprÃ  definire il concetto?
- [ ] **Doingness:** L'utente saprÃ  applicarlo passo per passo?
- [ ] **Teoria:** L'utente capirÃ  perchÃ© funziona?

---

### 6. Struttura Esercizio Vincolante (OBBLIGATORIA)

> **âš ï¸ REGOLA INDEROGABILE:** Ogni esercizio DEVE seguire questa struttura. Esercizi che non rispettano questo schema NON possono essere pubblicati.

#### Schema Completo Esercizio

```typescript
interface ExerciseComplete {
  // === IDENTIFICAZIONE ===
  id: string;
  week_number: number;              // 1-52
  title: string;                    // Titolo evocativo
  subtitle: string;                 // Sottotitolo descrittivo
  characteristic_slug: string;      // Collegamento a caratteristica

  // === CATEGORIZZAZIONE ===
  pillar: 'Vision' | 'Action' | 'Relations' | 'Adaptation';
  exercise_type: 'riconoscimento' | 'espansione' | 'sfida' | 'integrazione';
  difficulty_level: 'base' | 'intermedio' | 'avanzato';
  quarter: 'Q1' | 'Q2' | 'Q3' | 'Q4';
  estimated_time_minutes: number;

  // === PREVENZIONE 3 BARRIERE ===
  glossary: {                       // BARRIERA 1: Parole mal comprese
    term: string;
    definition: string;
    example: string;
  }[];

  concrete_examples: {              // BARRIERA 2: Mancanza concretezza
    situation: string;              // Situazione riconoscibile
    application: string;            // Come si applica
  }[];

  prerequisites: string[];          // BARRIERA 3: Gradiente saltato
                                    // Lista di cosa l'utente deve giÃ  sapere

  // === LIVELLO 1: DATI STABILI (COSA) ===
  key_concepts: {
    concept: string;                // Il concetto
    definition: string;             // Definizione chiara
    why_important: string;          // PerchÃ© Ã¨ importante
  }[];

  // === LIVELLO 2: DOINGNESS (COME) ===
  intro_validante: string;          // Intro che PRESUME la capacitÃ  esistente

  phase_1_recognition: {            // Fase ESSERE
    title: string;                  // "Riconoscimento - Chi Eri"
    being_focus: string;            // IdentitÃ  quando operi cosÃ¬
    prompt: string;                 // "Quando hai giÃ  operato con [X]?"
    instructions: string[];         // Passi concreti
  };

  phase_2_pattern: {                // Fase FARE
    title: string;                  // "Pattern - Cosa Facevi"
    doing_focus: string;            // Comportamento caratteristico
    prompt: string;                 // "Cosa caratterizzava quei momenti?"
    guiding_questions: string[];    // Domande guida
  };

  phase_3_expansion: {              // Fase AVERE
    title: string;                  // "Espansione - Come Ricreare"
    having_focus: string;           // Risultato ottenibile
    prompt: string;                 // "Come portare quel pattern dove non lo usi?"
    action_steps: string[];         // Passi azione concreti
  };

  deliverable: string;              // Output tangibile richiesto

  // === LIVELLO 3: TEORIA (PERCHÃ‰) ===
  why_it_works: {
    principle: string;              // Il principio sottostante
    explanation: string;            // Spiegazione del perchÃ© funziona
    scientific_basis?: string;      // Base scientifica (se applicabile)
  };

  // === VERIFICA COMPRENSIONE ===
  reflection_prompts: {
    level: 'dati_stabili' | 'doingness' | 'teoria';
    question: string;
  }[];

  // === SUPPORTO ===
  failure_response: string;         // Risposta validante se non completa
  ai_coach_hints: string[];         // Suggerimenti per AI Coach Fernando
}
```

#### Esempio Esercizio Conforme

```json
{
  "week_number": 1,
  "title": "La Consapevolezza che GiÃ  Operi",
  "subtitle": "Riconosci dove giÃ  usi l'autoconsapevolezza",
  "characteristic_slug": "autoconsapevolezza",
  "pillar": "Vision",
  "exercise_type": "riconoscimento",
  "difficulty_level": "base",
  "quarter": "Q1",
  "estimated_time_minutes": 25,

  "glossary": [
    {
      "term": "Autoconsapevolezza",
      "definition": "La capacitÃ  di osservare te stesso mentre agisci, come se ti guardassi dall'esterno",
      "example": "Quando guidi e ti accorgi di star pensando ad altro - quel momento di 'accorgerti' Ãˆ autoconsapevolezza"
    }
  ],

  "concrete_examples": [
    {
      "situation": "Sei in una riunione tesa e noti che ti stai irrigidendo",
      "application": "Il fatto stesso di NOTARE che ti stai irrigidendo Ã¨ autoconsapevolezza in azione"
    }
  ],

  "prerequisites": [],

  "key_concepts": [
    {
      "concept": "Autoconsapevolezza",
      "definition": "Vedere te stesso mentre operi",
      "why_important": "Senza vedere cosa fai, non puoi scegliere di cambiarlo"
    }
  ],

  "intro_validante": "Probabilmente prendi decisioni importanti ogni settimana senza chiamarle 'leadership'. Questo esercizio ti aiuta a RICONOSCERE la consapevolezza che giÃ  operi naturalmente - non a sviluppare qualcosa che ti manca.",

  "phase_1_recognition": {
    "title": "Riconoscimento - Chi Eri",
    "being_focus": "L'identitÃ  di chi osserva se stesso",
    "prompt": "Ricorda 3 decisioni importanti dell'ultimo anno. Per ognuna: come ti sentivi DURANTE?",
    "instructions": [
      "Trova un momento tranquillo di 10 minuti",
      "Scrivi 3 decisioni importanti dell'ultimo anno",
      "Per ogni decisione, nota l'emozione che provavi MENTRE decidevi",
      "Non giudicare se erano 'giuste' - osserva solo l'esperienza"
    ]
  },

  "phase_2_pattern": {
    "title": "Pattern - Cosa Facevi",
    "doing_focus": "Le condizioni che favorivano la consapevolezza",
    "prompt": "Cerca il pattern comune tra quei momenti",
    "guiding_questions": [
      "Eri solo o con altri?",
      "Era mattina, pomeriggio o sera?",
      "Eri in fretta o avevi calma?",
      "Dove ti trovavi fisicamente?"
    ]
  },

  "phase_3_expansion": {
    "title": "Espansione - Come Ricreare",
    "having_focus": "La capacitÃ  di ricreare quelle condizioni intenzionalmente",
    "prompt": "Come puoi ricreare quelle condizioni quando serve?",
    "action_steps": [
      "Scegli UNA condizione che puoi replicare facilmente",
      "Identifica UNA situazione della prossima settimana dove la userai",
      "Scrivi un promemoria per ricordarti"
    ]
  },

  "deliverable": "Documento con: 3 decisioni + emozioni durante + pattern comune + 1 condizione da replicare + 1 situazione dove la userai",

  "why_it_works": {
    "principle": "L'attenzione crea scelta",
    "explanation": "Quando noti cosa stai facendo, puoi scegliere se continuare o cambiare. Senza notare, reagisci automaticamente. L'autoconsapevolezza trasforma reazioni automatiche in scelte consapevoli.",
    "scientific_basis": "Metacognizione - la capacitÃ  del cervello di osservare i propri processi mentali"
  },

  "reflection_prompts": [
    {
      "level": "dati_stabili",
      "question": "Con parole tue, cos'Ã¨ l'autoconsapevolezza?"
    },
    {
      "level": "doingness",
      "question": "Descrivi i passi che hai seguito per identificare il tuo pattern"
    },
    {
      "level": "teoria",
      "question": "PerchÃ© notare cosa fai ti dÃ  piÃ¹ potere di scelta?"
    }
  ],

  "failure_response": "Forse stai cercando decisioni 'grandi'. Prova con decisioni piÃ¹ piccole ma comunque significative per te - anche scegliere di NON decidere Ã¨ una decisione.",

  "ai_coach_hints": [
    "Se l'utente fatica a trovare decisioni, suggerisci: assunzioni, licenziamenti, investimenti, cambio fornitori",
    "Se l'utente non trova pattern, aiutalo a cercare: luogo fisico, ora del giorno, stato emotivo pre-decisione"
  ]
}
```

#### Validazione Obbligatoria

Prima di pubblicare un esercizio, verifica:

```
âœ… PREVENZIONE BARRIERE
â–¡ Glossary: Tutti i termini non comuni hanno definizione + esempio?
â–¡ Concrete examples: Ci sono almeno 2 situazioni riconoscibili?
â–¡ Prerequisites: Ãˆ chiaro cosa l'utente deve giÃ  sapere?

âœ… LIVELLO 1 - DATI STABILI
â–¡ Key concepts: Ogni concetto ha definizione + why_important?
â–¡ L'utente saprÃ  rispondere a "Cos'Ã¨ [X]?"

âœ… LIVELLO 2 - DOINGNESS
â–¡ Phase 1-2-3: Tutte e 3 le fasi sono complete?
â–¡ Instructions/steps: Sono concreti e sequenziali?
â–¡ L'utente saprÃ  rispondere a "Come si fa [X]?"

âœ… LIVELLO 3 - TEORIA
â–¡ Why it works: C'Ã¨ principle + explanation?
â–¡ L'utente saprÃ  rispondere a "PerchÃ© funziona [X]?"

âœ… VERIFICA COMPRENSIONE
â–¡ Reflection prompts: Ci sono domande per tutti e 3 i livelli?

âœ… LINGUAGGIO VALIDANTE
â–¡ Intro presume la capacitÃ  esistente (mai deficit)?
â–¡ Failure response Ã¨ validante (non giudicante)?
```

---

## STRUTTURA PROGETTO COMPLETA

### Pagine (35+)

```
src/app/
â”œâ”€â”€ page.tsx                     # Homepage
â”œâ”€â”€ auth/
â”‚   â”œâ”€â”€ login/page.tsx
â”‚   â”œâ”€â”€ signup/page.tsx
â”‚   â”œâ”€â”€ forgot-password/page.tsx
â”‚   â””â”€â”€ reset-password/page.tsx
â”‚
â”œâ”€â”€ dashboard/
â”‚   â”œâ”€â”€ layout.tsx               # Layout con sidebar
â”‚   â””â”€â”€ page.tsx                 # Dashboard principale
â”‚
â”œâ”€â”€ assessment/
â”‚   â”œâ”€â”€ leadership/
â”‚   â”‚   â”œâ”€â”€ page.tsx             # 72 domande Leadership
â”‚   â”‚   â””â”€â”€ results/page.tsx     # Risultati radar chart
â”‚   â”œâ”€â”€ risolutore/
â”‚   â”‚   â”œâ”€â”€ page.tsx             # 48 domande Risolutore
â”‚   â”‚   â””â”€â”€ results/page.tsx     # Risultati
â”‚   â””â”€â”€ microfelicita/
â”‚       â”œâ”€â”€ page.tsx             # 47 domande MicrofelicitÃ 
â”‚       â””â”€â”€ results/page.tsx     # Risultati
â”‚
â”œâ”€â”€ exercises/
â”‚   â”œâ”€â”€ page.tsx                 # Lista 52 esercizi
â”‚   â””â”€â”€ [exerciseId]/page.tsx    # Dettaglio esercizio
â”‚
â”œâ”€â”€ challenge/                   # FUNNEL 7 GIORNI
â”‚   â”œâ”€â”€ leadership/page.tsx      # Landing A/B (amber)
â”‚   â”œâ”€â”€ ostacoli/page.tsx        # Landing A/B (emerald)
â”‚   â”œâ”€â”€ microfelicita/page.tsx   # Landing A/B (violet)
â”‚   â””â”€â”€ [type]/
â”‚       â”œâ”€â”€ day/[day]/page.tsx   # Contenuto giorno 1-7
â”‚       â””â”€â”€ complete/page.tsx    # Completamento
â”‚
â”œâ”€â”€ libro/                       # SALES FUNNEL LIBRI
â”‚   â””â”€â”€ [slug]/
â”‚       â”œâ”€â”€ page.tsx             # Landing libro (leadership|risolutore|microfelicita)
â”‚       â”œâ”€â”€ AcquistaButton.tsx   # Bottone checkout
â”‚       â””â”€â”€ grazie/page.tsx      # Thank you post-acquisto
â”‚
â”œâ”€â”€ admin/                       # ADMIN PANEL (9 pagine)
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”œâ”€â”€ users/page.tsx
â”‚   â”œâ”€â”€ analytics/page.tsx
â”‚   â”œâ”€â”€ ai-coach/page.tsx
â”‚   â”œâ”€â”€ api-costs/page.tsx
â”‚   â”œâ”€â”€ performance/page.tsx
â”‚   â”œâ”€â”€ quality-audit/page.tsx
â”‚   â”œâ”€â”€ feedback-patterns/page.tsx
â”‚   â”œâ”€â”€ corrections/page.tsx
â”‚   â””â”€â”€ ab-testing/page.tsx
â”‚
â”œâ”€â”€ profile/page.tsx
â”œâ”€â”€ progress/page.tsx
â”œâ”€â”€ results/page.tsx
â”œâ”€â”€ pricing/page.tsx
â”œâ”€â”€ subscription/page.tsx
â”œâ”€â”€ contact/page.tsx
â”œâ”€â”€ terms/page.tsx
â””â”€â”€ privacy/page.tsx
```

### API Endpoints (38+)

```
src/app/api/
â”œâ”€â”€ ai-coach/
â”‚   â”œâ”€â”€ route.ts                 # POST - Chat principale Claude
â”‚   â”œâ”€â”€ conversations/route.ts   # GET - Lista conversazioni
â”‚   â”œâ”€â”€ feedback/route.ts        # POST - Feedback messaggio
â”‚   â”œâ”€â”€ edit/route.ts            # POST - Modifica messaggio
â”‚   â”œâ”€â”€ reformulate/route.ts     # POST - Riformulazione
â”‚   â”œâ”€â”€ history/route.ts         # GET - Storico paginato
â”‚   â”œâ”€â”€ export/route.ts          # POST - Export PDF/JSON
â”‚   â”œâ”€â”€ signals/route.ts         # POST - Segnali impliciti
â”‚   â””â”€â”€ cron/
â”‚       â”œâ”€â”€ daily-metrics/route.ts
â”‚       â””â”€â”€ weekly-report/route.ts
â”‚
â”œâ”€â”€ assessment/
â”‚   â”œâ”€â”€ questions/route.ts       # GET - 72 domande
â”‚   â”œâ”€â”€ session/route.ts         # POST - Crea/recupera sessione
â”‚   â”œâ”€â”€ answer/route.ts          # POST - Salva risposta
â”‚   â”œâ”€â”€ complete/route.ts        # POST - Completa assessment
â”‚   â””â”€â”€ results/[id]/route.ts    # GET - Risultati
â”‚
â”œâ”€â”€ stripe/
â”‚   â”œâ”€â”€ checkout/route.ts        # POST - Checkout subscription
â”‚   â”œâ”€â”€ portal/route.ts          # POST - Customer portal
â”‚   â””â”€â”€ webhook/route.ts         # POST - Webhook Stripe
â”‚
â”œâ”€â”€ challenge/
â”‚   â”œâ”€â”€ subscribe/route.ts       # POST - Iscrizione + welcome email
â”‚   â”œâ”€â”€ complete-day/route.ts    # POST - Completa giorno
â”‚   â””â”€â”€ check-unlock/route.ts    # POST - Verifica sblocco
â”‚
â”œâ”€â”€ libro/
â”‚   â””â”€â”€ checkout/route.ts        # POST - Checkout libro singolo
â”‚
â”œâ”€â”€ recommendations/route.ts     # GET - Esercizi raccomandati
â”‚
â”œâ”€â”€ cron/
â”‚   â””â”€â”€ send-challenge-emails/route.ts  # Cron giornaliero
â”‚
â””â”€â”€ admin/
    â”œâ”€â”€ users/route.ts
    â”œâ”€â”€ analytics/route.ts
    â””â”€â”€ ai-coach/dashboard/route.ts
```

### Componenti (24+)

```
src/components/
â”œâ”€â”€ ai-coach/
â”‚   â”œâ”€â”€ ChatWidget.tsx           # Widget chat principale
â”‚   â”œâ”€â”€ ConversationHistory.tsx  # Storico conversazioni
â”‚   â””â”€â”€ ExportButton.tsx         # Export PDF/JSON
â”‚
â”œâ”€â”€ dashboard/
â”‚   â”œâ”€â”€ WelcomeHero.tsx          # Hero benvenuto
â”‚   â”œâ”€â”€ AssessmentCard.tsx       # Card assessment
â”‚   â”œâ”€â”€ QuickStats.tsx           # Statistiche rapide
â”‚   â”œâ”€â”€ TrialBanner.tsx          # Banner trial
â”‚   â”œâ”€â”€ MiniRadarPreview.tsx     # Mini radar chart
â”‚   â”œâ”€â”€ ExercisesCard.tsx        # Card esercizi
â”‚   â”œâ”€â”€ RecommendedExercises.tsx # Esercizi raccomandati
â”‚   â””â”€â”€ RecentActivity.tsx       # AttivitÃ  recente
â”‚
â”œâ”€â”€ assessment/
â”‚   â”œâ”€â”€ QuestionCard.tsx         # Card domanda
â”‚   â”œâ”€â”€ ProgressBar.tsx          # Barra progresso
â”‚   â””â”€â”€ ResultsRadar.tsx         # Radar risultati
â”‚
â”œâ”€â”€ charts/
â”‚   â””â”€â”€ LeadershipRadarChart.tsx # Radar chart Recharts
â”‚
â”œâ”€â”€ layout/
â”‚   â”œâ”€â”€ Sidebar.tsx              # Sidebar navigazione
â”‚   â””â”€â”€ DashboardHeader.tsx      # Header
â”‚
â”œâ”€â”€ exercises/
â”‚   â”œâ”€â”€ ExercisesList.tsx        # Lista esercizi
â”‚   â”œâ”€â”€ ExerciseDetail.tsx       # Dettaglio
â”‚   â””â”€â”€ LockedExerciseView.tsx   # Vista bloccata
â”‚
â””â”€â”€ challenge/
    â””â”€â”€ DiscoveryConfirmation.tsx # Quiz A/B/C
```

### Librerie (src/lib/)

```
src/lib/
â”œâ”€â”€ ai-coach/
â”‚   â”œâ”€â”€ types.ts                 # Interfacce TypeScript
â”‚   â”œâ”€â”€ system-prompt.ts         # Prompt Fernando completo
â”‚   â”œâ”€â”€ user-memory.ts           # Memoria personalizzazione
â”‚   â”œâ”€â”€ pattern-recognition.ts   # Pattern detection
â”‚   â”œâ”€â”€ implicit-signals.ts      # Segnali impliciti
â”‚   â”œâ”€â”€ daily-metrics.ts         # Metriche giornaliere
â”‚   â””â”€â”€ weekly-report.ts         # Report settimanale
â”‚
â”œâ”€â”€ supabase/
â”‚   â”œâ”€â”€ client.ts                # Client browser
â”‚   â”œâ”€â”€ server.ts                # Client server
â”‚   â””â”€â”€ middleware.ts            # Auth middleware
â”‚
â”œâ”€â”€ services/
â”‚   â””â”€â”€ exercise-recommendation.ts # Raccomandazioni esercizi
â”‚
â”œâ”€â”€ challenge/
â”‚   â”œâ”€â”€ day-content.ts           # Contenuti 7 giorni (Ã—3 challenge)
â”‚   â””â”€â”€ discovery-data.ts        # 63 domande discovery A/B/C
â”‚
â”œâ”€â”€ email/
â”‚   â””â”€â”€ challenge-day-templates.ts # 21 template email + system emails
â”‚
â”œâ”€â”€ rag.ts                       # RAG System (OpenAI embeddings)
â”œâ”€â”€ assessment-scoring.ts        # Calcolo punteggi assessment
â”‚
â”œâ”€â”€ types/
â”‚   â”œâ”€â”€ roles.ts                 # RBAC + subscription tiers
â”‚   â””â”€â”€ exercises.ts             # Tipi esercizi
â”‚
â””â”€â”€ data/
    â””â”€â”€ libri.ts                 # Dati 3 libri
```

---

## I 3 LIBRI / PERCORSI

| Libro | Slug | Colore | Prezzo |
|-------|------|--------|--------|
| Leadership Autentica | `leadership` | Oro #D4AF37 | â‚¬9.90 |
| Oltre gli Ostacoli | `risolutore` | Verde #10B981 | â‚¬9.90 |
| MicrofelicitÃ  Digitale | `microfelicita` | Viola #8B5CF6 | â‚¬9.90 |

---

## I 4 PILASTRI (24 Caratteristiche)

| Pilastro | Nome IT | Colore | Caratteristiche |
|----------|---------|--------|-----------------|
| ESSERE | Visione | #3B82F6 (blu) | 6 |
| SENTIRE | Relazioni | #10B981 (verde) | 6 |
| PENSARE | Adattamento | #8B5CF6 (viola) | 6 |
| AGIRE | Azione | #F59E0B (arancione) | 6 |

**Totale: 24 caratteristiche di leadership**

---

## SISTEMA CHALLENGE (Funnel 7 Giorni)

### 3 Challenge con A/B Testing

| Challenge | URL | Colore | Varianti |
|-----------|-----|--------|----------|
| Leadership Autentica | `/challenge/leadership` | Amber | A/B/C |
| Oltre gli Ostacoli | `/challenge/ostacoli` | Emerald | A/B/C |
| MicrofelicitÃ  | `/challenge/microfelicita` | Violet | A/B/C |

### Flusso
```
1. Landing con A/B testing â†’ Form iscrizione
2. POST /api/challenge/subscribe â†’ Salva + Welcome email
3. [7 giorni] Email contenuto â†’ /challenge/[type]/day/[1-7]
4. Quiz discovery 3 domande A/B/C per giorno
5. Completamento â†’ CTA Assessment/Libro
```

### Email System (Resend)
- **21 template** contenuto (7 giorni Ã— 3 challenge)
- **Reminder** (48h inattivitÃ )
- **Force Advance** (72h inattivitÃ )
- **Recovery** (3 giorni post-challenge)
- **Cron job:** `/api/cron/send-challenge-emails` (8:00 UTC)

---

## REGOLE TECNICHE PER FLUSSO CHALLENGE (CONTRATTO)

> **Principio guida:** L'utente Ã¨ AGENTE ATTIVO. La progressione dipende dalle SUE azioni, non dal tempo.

### 1. Semantica `current_day` (FONTE DI VERITÃ€ UNICA)

| Valore | Significato |
|--------|-------------|
| `0` | Iscritto, nessun giorno completato |
| `1` | Day 1 completato |
| `N` | Day N completato |
| `7` | Challenge completata |

```
âš ï¸ REGOLA CRITICA:
current_day = ULTIMO GIORNO COMPLETATO dall'utente
NON "prossimo da fare", NON "ultimo email inviato"
```

### 2. Tabelle Database e Ruoli

| Tabella | Ruolo | Fonte di veritÃ  per |
|---------|-------|---------------------|
| `challenge_subscribers` | Master | Stato iscrizione, `current_day`, status |
| `challenge_day_completions` | Tracking | Timestamp completamento + email inviate |
| `challenge_discovery_responses` | Analytics | Risposte discovery (opzionale) |
| `ab_test_events` | Analytics | Eventi A/B testing |

```
âš ï¸ REGOLA: challenge_subscribers.current_day Ã¨ l'UNICA fonte di veritÃ 
per determinare quali giorni sono sbloccati/completati.
```

### 3. Logica Sblocco Giorni

```typescript
// REGOLA DI SBLOCCO
const isUnlocked = (dayNumber: number, currentDay: number, isSubscribed: boolean) => {
  if (!isSubscribed) return false;           // Non iscritto â†’ nessun accesso
  if (dayNumber === 1) return true;          // Day 1 sempre sbloccato se iscritto
  return dayNumber <= currentDay + 1;        // Day N sbloccato se N-1 completato
};

// REGOLA DI COMPLETAMENTO
const isCompleted = (dayNumber: number, currentDay: number) => {
  return dayNumber <= currentDay;            // Completato se <= current_day
};
```

**Esempi:**
| `current_day` | Day 1 | Day 2 | Day 3 | Day 4-7 |
|---------------|-------|-------|-------|---------|
| 0 | ğŸ”“ Sbloccato | ğŸ”’ | ğŸ”’ | ğŸ”’ |
| 1 | âœ… Completato | ğŸ”“ Sbloccato | ğŸ”’ | ğŸ”’ |
| 2 | âœ… | âœ… Completato | ğŸ”“ Sbloccato | ğŸ”’ |
| 7 | âœ… | âœ… | âœ… | âœ… Challenge completa |

### 4. API Contracts

#### POST `/api/challenge/subscribe`
```typescript
// INPUT
{ email, nome, challenge, variant }

// AZIONI
1. Verifica email non giÃ  iscritto a questa challenge
2. Crea record in challenge_subscribers con:
   - current_day: 0  // âš ï¸ ZERO, non 1!
   - status: 'active'
3. Invia welcome email
4. Aggiorna last_email_sent_at, last_email_type: 'welcome'

// OUTPUT
{ success: true, subscriberId }
```

#### POST `/api/challenge/complete-day`
```typescript
// INPUT
{ email, challengeType, dayNumber, responses }

// VALIDAZIONI
1. Utente deve essere iscritto (challenge_subscribers esiste)
2. dayNumber deve essere <= current_day + 1 (giorno sbloccato)
3. dayNumber non deve essere giÃ  completato

// AZIONI
1. Salva completamento in challenge_day_completions
2. Aggiorna challenge_subscribers:
   - current_day: dayNumber  // âš ï¸ IL GIORNO APPENA COMPLETATO, non dayNumber+1!
   - last_activity_at: now()
3. Se dayNumber === 7: status: 'completed', invia email finale

// OUTPUT
{ success: true, nextDay: dayNumber + 1, isCompleted: dayNumber === 7 }
```

#### Cron `/api/cron/send-challenge-emails`
```typescript
// LOGICA INVIO EMAIL
Per ogni subscriber con status: 'active':

1. SE current_day === 0 E last_email_type === 'welcome':
   â†’ Invia email Day 1 (contenuto, non welcome)
   â†’ Aggiorna last_email_type: 'day_1'

2. SE current_day >= 1 E current_day < 7:
   â†’ Calcola nextEmailDay = current_day + 1
   â†’ SE last_email_type !== 'day_' + nextEmailDay:
     â†’ Invia email Day nextEmailDay
     â†’ Aggiorna last_email_type: 'day_' + nextEmailDay

// âš ï¸ REGOLA USER AGENCY:
Il cron invia email del giorno SUCCESSIVO solo DOPO che l'utente
ha completato il giorno corrente. L'utente controlla la progressione.
```

### 5. Autenticazione e Accesso

| Pagina | Auth Required | Iscrizione Required |
|--------|---------------|---------------------|
| `/challenge/[type]` (landing) | âŒ No | âŒ No |
| `/challenge/[type]/day/[N]` | âœ… SÃ¬ | âœ… SÃ¬ |
| `/challenge/[type]/complete` | âœ… SÃ¬ | âœ… SÃ¬ + Day 7 completato |

```typescript
// VERIFICA ACCESSO DAY PAGE
async function checkDayAccess(user, challengeType, dayNumber) {
  // 1. Verifica autenticazione
  if (!user) return { redirect: '/auth/login' };

  // 2. Verifica iscrizione
  const subscriber = await getSubscriber(user.email, challengeType);
  if (!subscriber) return { redirect: `/challenge/${challengeType}` };

  // 3. Verifica sblocco
  if (!isUnlocked(dayNumber, subscriber.current_day, true)) {
    return { locked: true, message: `Completa prima il Giorno ${dayNumber - 1}` };
  }

  return { allowed: true, isCompleted: dayNumber <= subscriber.current_day };
}
```

### 6. Mapping Challenge Types

```typescript
// Frontend URL â†’ Database value
const CHALLENGE_TYPE_MAP = {
  'leadership': 'leadership-autentica',
  'ostacoli': 'oltre-ostacoli',
  'microfelicita': 'microfelicita'
};

// âš ï¸ Usare SEMPRE questo mapping per query database
```

### 7. Post-Challenge Flow (STOP â†’ START)

```
STOP: Challenge Day 7 completato
  â†“
CTA PRIMARIA: "Acquista il Libro" (â‚¬24,90 fisico / â‚¬9,90 PDF)
  - Il libro contiene QR code per Assessment Explorer
  â†“
CTA SECONDARIA: "Hai giÃ  il libro? Vai all'Assessment"
  â†“
START: Assessment Explorer (72 domande Leadership)
```

### 8. Checklist Implementazione

Prima di modificare codice challenge, verifica:

- [ ] `current_day` Ã¨ interpretato come "ultimo completato"?
- [ ] Subscribe setta `current_day: 0`?
- [ ] Complete-day setta `current_day: dayNumber` (non `dayNumber + 1`)?
- [ ] Hook usa `challenge_subscribers` come fonte unica?
- [ ] Day page verifica iscrizione PRIMA di mostrare contenuto?
- [ ] Cron rispetta user agency (non forza progressione)?

---

## SISTEMA ASSESSMENT

### 3 Assessment Indipendenti (per percorso)

| Assessment | Domande | Percorso | Dimensioni |
|------------|---------|----------|------------|
| **Leadership** | 72 | Leadership Autentica | 24 caratteristiche (4 pilastri) |
| **Risolutore** | 48 | Oltre gli Ostacoli | 3 Filtri (Pattern, Segnali, Risorse) |
| **MicrofelicitÃ ** | 47 | MicrofelicitÃ  Digitale | 5 fasi R.A.D.A.R. |

- **Scala 1-5:** Quasi mai â†’ Costantemente
- **Scoring:** Direct + Inverse
- **Output:** Radar chart specifico per assessment

### Tabelle DB
- `assessment_questions_v2` (domande per assessment)
- `user_assessments_v2` (sessioni con `assessment_type`)
- `user_answers_v2` (risposte)
- `characteristic_scores` (punteggi)

---

## SISTEMA AI COACH FERNANDO

> **âš ï¸ DOCUMENTO COMPLETO:** `docs/AI_COACH_SYSTEM.md` contiene system prompt, scenari, safety protocols e compliance.

### Architettura
```
ChatWidget â†’ /api/ai-coach â†’ Claude API
                â†“
            RAG System â†’ book_chunks (pgvector)
                â†“
            User Memory â†’ ai_coach_user_memory
```

### System Prompt (Estratto)
```
Sei Fernando Marongiu, autore della trilogia "Rivoluzione Aurea".
Le persone hanno giÃ  dentro di sÃ© le capacitÃ  di leadership.
Non devono "acquisirle" - devono RICONOSCERLE e ESPANDERLE.
```

### Esercizi nel Database
| Percorso | Fondamentali | Applicazione | Mentor | Totale |
|----------|--------------|--------------|--------|--------|
| Leadership | 4 | 52 | 8 | 64 |
| Risolutore | 4 | 24 | 3 | 31 |
| MicrofelicitÃ  | 4 | 24 | 3 | 31 |
| **TOTALE** | **12** | **100** | **14** | **126** |

### User Memory
- `communication_style`: directive | socratic | storytelling
- `preferred_response_length`: brief | moderate | detailed
- `common_challenges[]`
- `successful_approaches[]`
- `trigger_topics[]`

### RAG (3 Libri)
- Embeddings: OpenAI `text-embedding-3-small`
- Vector search: pgvector su Supabase
- Filter per `current_path`: leadership | problemi | benessere

---

## DESIGN SYSTEM

### Colori Primari
```css
--petrol-600: #0A2540;     /* Blu Petrolio - Primary */
--gold-500: #F4B942;       /* Oro - Accent */
```

### Pilastri
```css
--pillar-being: #3B82F6;   /* Blu - Visione */
--pillar-feeling: #10B981; /* Verde - Relazioni */
--pillar-thinking: #8B5CF6;/* Viola - Adattamento */
--pillar-acting: #F59E0B;  /* Arancione - Azione */
```

### Typography
- **Display/Headings:** Stoke (serif)
- **Body:** Inter (sans-serif)

### Classi CSS Globali
```css
.btn-primary    /* bg-petrol-600 text-white */
.btn-secondary  /* bg-gold-500 text-petrol-600 */
.card           /* bg-white rounded-xl shadow-sm border */
```

---

## DATABASE (Supabase)

### Tabelle Principali
| Tabella | Righe | Descrizione |
|---------|-------|-------------|
| `profiles` | N | Profili utente (extends auth.users) |
| `characteristics` | 24 | Caratteristiche leadership |
| `assessment_questions` | 72/240 | Domande assessment |
| `exercises` | 52 | Esercizi settimanali |
| `user_exercise_progress` | N | Progresso esercizi |
| `ai_coach_conversations` | N | Storico chat AI |
| `ai_coach_user_memory` | N | Memoria personalizzazione |
| `challenge_subscribers` | N | Iscritti challenge |
| `challenge_discovery_responses` | N | Risposte quiz A/B/C |
| `book_chunks` | N | Chunks RAG con embeddings |

### RLS Attivo
Ogni utente vede solo i propri dati.

---

## SUBSCRIPTION TIERS

> Riferimento: `docs/ARCHITETTURA_DASHBOARD_VITAEOLOGY_DEFINITIVA.md`

| Tier | Prezzo | Percorsi | AI Coach | Esercizi | Extra |
|------|--------|----------|----------|----------|-------|
| **Challenge** | â‚¬0 | âŒ | âŒ | âŒ | 7 giorni email + discovery |
| **Leader** | â‚¬149/anno | 1 a scelta | âœ… Illimitato | Pool percorso scelto | - |
| **Mentor** | â‚¬490/anno | Tutti e 3 | âœ… Illimitato | Tutti i pool | 2 sessioni 1:1/anno, Certificazione |

### Flusso Progressione
```
Challenge (â‚¬0) â†’ Leader (â‚¬149) â†’ Mentor (â‚¬490) â†’ Certificazione
```

### Paradigma Esercizi (IMPORTANTE)
```
âš ï¸ NON esiste percorso sequenziale "Settimana 1, 2, 3..."

AI Fernando:
- Ha accesso al pool completo di esercizi del percorso
- Conosce i risultati assessment dell'utente
- PROPONE l'esercizio giusto per quella persona in quel momento
- SPIEGA PERCHÃ‰ quell'esercizio Ã¨ rilevante
```

---

## VARIABILI AMBIENTE (.env.local)

```bash
# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# Stripe
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=
STRIPE_SECRET_KEY=
STRIPE_WEBHOOK_SECRET=
STRIPE_PRICE_LEADER_ANNUAL=
STRIPE_PRICE_MENTOR_ANNUAL=

# AI
ANTHROPIC_API_KEY=
OPENAI_API_KEY=

# Email
RESEND_API_KEY=

# Cron
CRON_SECRET=

# App
NEXT_PUBLIC_APP_URL=
```

---

## COMANDI UTILI

```bash
npm run dev          # Avvia dev server
npm run build        # Build produzione
npm run lint         # ESLint

# Script utility
node scripts/run-sql.js sql/file.sql
node scripts/verify_ai_coach_tables.js
```

---

## SAFETY PROTOCOLS

Se l'utente menziona suicidio/autolesionismo:

```
ğŸš¨ Non sono qualificato per gestire situazioni di crisi.
Contatta IMMEDIATAMENTE:
â€¢ EMERGENZE: 112
â€¢ Telefono Amico: 199 284 284
â€¢ Samaritans Onlus: 800 86 00 22
```

---

## SICUREZZA INTRINSECA DATABASE (OBBLIGATORIO)

> **âš ï¸ PRINCIPIO FONDAMENTALE:** La sicurezza deve essere BY DESIGN, non BY FIX.
> Ogni componente database DEVE essere sicuro al momento della creazione.

### 1. Regole Inderogabili

```
âŒ MAI creare views senza SECURITY INVOKER
âŒ MAI creare tabelle senza RLS + policies
âŒ MAI esporre auth.users in views/funzioni public
âŒ MAI usare SECURITY DEFINER senza necessitÃ  documentata
```

### 2. Template Creazione Sicura

#### VIEW (sempre con security_invoker)
```sql
-- âœ… CORRETTO: security_invoker = on
CREATE VIEW public.my_view
WITH (security_invoker = on) AS
SELECT ...;

-- âŒ SBAGLIATO: senza security_invoker (usa DEFINER di default)
CREATE VIEW public.my_view AS
SELECT ...;
```

#### TABELLA (sempre con RLS + policy)
```sql
-- âœ… CORRETTO: RLS abilitato + policy
CREATE TABLE public.my_table (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES auth.users(id) NOT NULL,
  ...
);

-- Abilita RLS IMMEDIATAMENTE
ALTER TABLE public.my_table ENABLE ROW LEVEL SECURITY;

-- Crea policy IMMEDIATAMENTE
CREATE POLICY "Users can only see own data" ON public.my_table
  FOR ALL USING (auth.uid() = user_id);

-- âŒ SBAGLIATO: tabella senza RLS
CREATE TABLE public.my_table (...);
-- "Lo aggiungo dopo" = vulnerabilitÃ 
```

#### FUNZIONE (INVOKER di default, DEFINER solo se necessario)
```sql
-- âœ… CORRETTO: SECURITY INVOKER (default, esplicito per chiarezza)
CREATE FUNCTION public.my_function()
RETURNS ...
SECURITY INVOKER  -- Esegue con permessi del chiamante
AS $$ ... $$;

-- âš ï¸ SECURITY DEFINER solo se NECESSARIO (documentare il perchÃ©)
CREATE FUNCTION public.admin_only_function()
RETURNS ...
SECURITY DEFINER  -- ATTENZIONE: bypassa RLS!
-- MOTIVO: Questa funzione deve accedere a dati admin per [MOTIVO]
AS $$ ... $$;
```

### 3. Script Audit Sicurezza

**File:** `sql/security_audit.sql`

**Eseguire PRIMA di ogni deploy:**
```bash
# In Supabase SQL Editor, esegui tutto il contenuto di:
sql/security_audit.sql
```

**Output atteso (sicuro):**
```
ZERO views con SECURITY DEFINER
ZERO tabelle senza RLS
ZERO tabelle con RLS ma senza policies
ZERO riferimenti a auth.users in views public
```

### 4. Checklist Pre-Deploy (OBBLIGATORIA)

Prima di OGNI deploy che modifica il database:

```
â–¡ Ho eseguito sql/security_audit.sql?
â–¡ Tutte le nuove views hanno security_invoker = on?
â–¡ Tutte le nuove tabelle hanno RLS + policies?
â–¡ Nessuna view/funzione espone auth.users?
â–¡ Ogni SECURITY DEFINER ha un commento che spiega PERCHÃ‰?
```

### 5. Anti-Pattern da Evitare

| Anti-Pattern | Problema | Soluzione |
|--------------|----------|-----------|
| "Lo sistemo dopo" | Finestra di vulnerabilitÃ  | Sicurezza al momento della creazione |
| View senza security_invoker | Bypassa RLS utente | `WITH (security_invoker = on)` |
| Tabella â†’ poi RLS | Dati esposti nel frattempo | RLS nella stessa transazione |
| SECURITY DEFINER "per comoditÃ " | Privilegi eccessivi | INVOKER + grants specifici |
| SELECT * FROM auth.users | Espone dati sensibili | Mai in schema public |

### 6. Audit Periodico

| Frequenza | Azione |
|-----------|--------|
| **Pre-deploy** | Esegui `sql/security_audit.sql` |
| **Settimanale** | Verifica `SELECT * FROM auth.security_warnings()` |
| **Mensile** | Review completa policies RLS |

---

## PROTOCOLLO MANUTENZIONE SESSIONE

### 1. INIZIO SESSIONE (Obbligatorio)

```bash
# Check health endpoint
curl -s "https://www.vitaeology.com/api/cron/monitoring" \
  -H "Authorization: Bearer $CRON_SECRET"
```

**Verifica:**
- `success: true`
- `isAnomaly: false`
- `alertsTriggered: 0`

Se ci sono problemi critici â†’ **RISOLVILI PRIMA** di procedere con altre richieste.

### 2. DURANTE MODIFICHE SIGNIFICATIVE

Prima di completare qualsiasi modifica:
- âŒ ZERO nuovi errori TypeScript
- âŒ ZERO nuovi `console.error` non gestiti
- âŒ ZERO regressioni significative

```bash
npm run lint   # Deve passare senza errori
npm run build  # Deve completare con successo
```

### 3. FINE SESSIONE

- Conferma health check pulito
- Documenta TODO aperti nel messaggio finale

### 4. CALENDARIO MANUTENZIONE

| Frequenza | AttivitÃ  |
|-----------|----------|
| **Giornaliero** | Health check rapido (2 min) |
| **Pre-deploy** | `npm run lint && npm run build` obbligatorio |
| **LunedÃ¬** | Review settimanale errori Vercel |
| **1Â° del mese** | Pulizia log, `npm audit`, aggiorna dipendenze |
| **Trimestrale** | Audit completo architettura |

### 5. PATTERN SPAM CHALLENGE SUBSCRIBERS

Email spam tipiche hanno **punti random inseriti** nel nome:
```
âŒ s.hi.nz.y@gmail.com        (shinzy)
âŒ a.b.oal.r.ezz@gmail.com    (aboalrezz)
âŒ ka.yl.a.c.o.na@gmail.com   (kaylacona)
```

**Script pulizia spam:**
```javascript
// Pattern: piÃ¹ di 3 punti nella parte locale + meno di 15 lettere
const suspicious = subscribers.filter(s => {
  const local = s.email.split('@')[0];
  const dots = (local.match(/\./g) || []).length;
  const letters = local.replace(/[^a-zA-Z]/g, '').length;
  return dots > 3 && letters < 15;
});
```

### 6. CRON JOBS

| Endpoint | Schedule | Descrizione |
|----------|----------|-------------|
| `/api/cron/monitoring` | `*/15 * * * *` | Health check ogni 15 min |
| `/api/cron/challenge-emails` | `0 8 * * *` | Email challenge 8:00 UTC |
| `/api/cron/affiliate-emails` | `0 9 * * *` | Email affiliati 9:00 UTC |
| `/api/ai-coach/cron/combined` | `0 23 * * *` | Metriche AI 23:00 UTC |

**Test manuale cron:**
```bash
curl -s "https://www.vitaeology.com/api/cron/challenge-emails" \
  -H "Authorization: Bearer $CRON_SECRET"
```

**âš ï¸ IMPORTANTE:** I cron usano `CRON_SECRET` per auth. Le route `/api/cron/*` sono pubbliche nel middleware (no Supabase auth).

---

## DOCUMENTAZIONE DETTAGLIATA

Per documentazione completa, consulta `/docs`:

### âš ï¸ DOCUMENTI AUTORITATIVI (INSINDACABILI)

| File | Contenuto | AutoritÃ  su |
|------|-----------|-------------|
| `docs/ARCHITETTURA_DASHBOARD_VITAEOLOGY_DEFINITIVA.md` | **Architettura ufficiale** approvata da Fernando | Tier, flussi utente, dashboard, esercizi AI, certificazione |
| `docs/AI_COACH_SYSTEM.md` | **Fernando AI completo** - System prompt, scenari, safety | AI Coach, compliance, disclaimer, 126 esercizi |
| `docs/CUSTOMER_JOURNEY_VITAEOLOGY_COMPLETO.pdf` | **Customer Journey e Value Ladder** | 8 fasi, prezzi, funnel |

### Documenti di Riferimento

| File | Contenuto |
|------|-----------|
| `docs/PROGETTO_VITAEOLOGY_COMPLETO.md` | Documentazione tecnica master (1300+ righe) |
| `docs/DATABASE_SCHEMA.md` | Schema DB completo |
| `docs/ESERCIZI_STRUTTURA_COMPLETA.md` | Struttura 126 esercizi (12 Fond + 100 App + 14 Mentor) |
| `docs/QUICK_REFERENCE.md` | Riferimento rapido |

---

## NOTE PER CLAUDE CODE

1. **LEGGI SEMPRE** `docs/ARCHITETTURA_DASHBOARD_VITAEOLOGY_DEFINITIVA.md` per logiche di business (AUTOREVOLE)
2. **LEGGI** `/docs/PROGETTO_VITAEOLOGY_COMPLETO.md` prima di modifiche tecniche major
3. **IN CASO DI CONFLITTO** tra documenti, ARCHITETTURA_DASHBOARD prevale su altri docs
2. Usa `'use client'` per componenti interattivi
3. TypeScript strict sempre
4. Tailwind per styling, no CSS separato
5. Commenta in italiano
6. **Linguaggio validante** in tutto il codice UI/UX

---

## RIEPILOGO FUNZIONALITÃ€

| Area | Status | File |
|------|--------|------|
| 3 Assessment (Leadership/Risolutore/MicrofelicitÃ ) | âœ… | `src/app/assessment/[type]/` |
| AI Coach Fernando + RAG | âœ… | `src/lib/ai-coach/` |
| 126 Esercizi (12 Fond + 100 App + 14 Mentor) | âœ… | `src/app/exercises/` |
| 3 Challenge (7 giorni) A/B | âœ… | `src/app/challenge/` |
| 63 Domande Discovery | âœ… | `src/lib/challenge/discovery-data.ts` |
| 21 Template Email | âœ… | `src/lib/email/` |
| Cron Email Resend | âœ… | `src/app/api/cron/` |
| 3 Landing Libri | âœ… | `src/app/libro/` |
| Dashboard completa | âœ… | `src/app/dashboard/` |
| Admin Panel (9 pagine) | âœ… | `src/app/admin/` |
| Stripe Payments | âœ… | `src/app/api/stripe/` |
| User Memory AI | âœ… | `src/lib/ai-coach/user-memory.ts` |
| Pattern Recognition | âœ… | `src/lib/ai-coach/pattern-recognition.ts` |
